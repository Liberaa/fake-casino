<%- include('partials/header') %>
<%- include('partials/navbar', { user }) %>

<style>
.leaderboard-tabs {
  display: flex;
  gap: 1rem;
  margin-bottom: 2rem;
  justify-content: center;
  flex-wrap: wrap;
}

.tab-btn {
  padding: 0.75rem 1.5rem;
  background: rgba(255, 255, 255, 0.1);
  border: 2px solid rgba(255, 255, 255, 0.2);
  border-radius: 10px;
  color: #fff;
  cursor: pointer;
  font-weight: bold;
  transition: all 0.3s;
}

.tab-btn:hover {
  background: rgba(255, 255, 255, 0.2);
}

.tab-btn.active {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-color: #667eea;
}

.level-badge {
  font-size: 1.2rem;
  margin-right: 0.3rem;
}

.vip-crown {
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}
</style>

<div class="leaderboard-container">
  <h1>ğŸ† Leaderboard</h1>
  
  <div class="leaderboard-tabs">
    <button class="tab-btn active" onclick="switchTab('credits')">ğŸ’° Top Balances</button>
    <button class="tab-btn" onclick="switchTab('wagered')">ğŸ’¸ Total Wagered</button>
    <button class="tab-btn" onclick="switchTab('bigwin')">ğŸ° Biggest Win</button>
    <button class="tab-btn" onclick="switchTab('level')">ğŸ® Highest Level</button>
  </div>

  <div class="leaderboard-table">
    <div class="table-header" id="tableHeader">
      <div>Rank</div>
      <div>Player</div>
      <div>Brap Coins</div>
      <div>Wins</div>
      <div>Losses</div>
    </div>
    <div id="leaderboardList"></div>
  </div>
</div>

<script>
let currentTab = 'credits'

// Get level badge
function getLevelBadge(level) {
  if (level >= 1000) return 'ğŸ‘‘'
  if (level >= 500) return 'ğŸ’'
  if (level >= 250) return 'ğŸ†'
  if (level >= 100) return 'ğŸ¥‡'
  if (level >= 50) return 'ğŸ¥ˆ'
  if (level >= 25) return 'ğŸ¥‰'
  return 'ğŸ®'
}

// Get level tier name
function getLevelTier(level) {
  if (level >= 1000) return 'VIP Legend'
  if (level >= 500) return 'Diamond'
  if (level >= 250) return 'Platinum'
  if (level >= 100) return 'Gold'
  if (level >= 50) return 'Silver'
  if (level >= 25) return 'Bronze'
  return 'Beginner'
}

// Calculate total XP earned
function getTotalXP(level, currentXP) {
  let total = currentXP
  for (let i = 1; i < level; i++) {
    total += Math.floor(100 * Math.pow(i, 1.5))
  }
  return total
}

async function loadLeaderboard() {
  const res = await fetch(`/api/leaderboard?type=${currentTab}`)
  const data = await res.json()
  
  const list = document.getElementById('leaderboardList')
  const header = document.getElementById('tableHeader')
  list.innerHTML = ''
  
  // Update header based on tab
  if (currentTab === 'credits') {
    header.innerHTML = `
      <div>Rank</div>
      <div>Player</div>
      <div>Brap Coins</div>
      <div>Wins</div>
      <div>Losses</div>
    `
  } else if (currentTab === 'wagered') {
    header.innerHTML = `
      <div>Rank</div>
      <div>Player</div>
      <div>Total Wagered</div>
      <div>Games Played</div>
      <div>W/L Ratio</div>
    `
  } else if (currentTab === 'bigwin') {
    header.innerHTML = `
      <div>Rank</div>
      <div>Player</div>
      <div>Biggest Win</div>
      <div>Game Type</div>
      <div>Date</div>
    `
  } else if (currentTab === 'level') {
    header.innerHTML = `
      <div>Rank</div>
      <div>Player</div>
      <div>Level</div>
      <div>Tier</div>
      <div>Total XP</div>
    `
  }
  
  data.leaderboard.forEach((player, index) => {
    const row = document.createElement('div')
    row.className = 'table-row'
    
    let rankIcon = 'ğŸ‘¤'
    if (index === 0) rankIcon = 'ğŸ¥‡'
    else if (index === 1) rankIcon = 'ğŸ¥ˆ'
    else if (index === 2) rankIcon = 'ğŸ¥‰'
    
    if (currentTab === 'credits') {
      row.innerHTML = `
        <div>${rankIcon} ${index + 1}</div>
        <div>${player.username}</div>
        <div>ğŸ’° ${player.credits.toFixed(2)}</div>
        <div>âœ… ${player.totalWins}</div>
        <div>âŒ ${player.totalLosses}</div>
      `
    } else if (currentTab === 'wagered') {
      const ratio = player.totalGames > 0 ? ((player.totalWins / player.totalGames) * 100).toFixed(1) : '0.0'
      row.innerHTML = `
        <div>${rankIcon} ${index + 1}</div>
        <div>${player.username}</div>
        <div>ğŸ’¸ ${player.totalWagered.toFixed(2)}</div>
        <div>ğŸ² ${player.totalGames}</div>
        <div>ğŸ“Š ${ratio}%</div>
      `
    } else if (currentTab === 'bigwin') {
      const date = new Date(player.date).toLocaleDateString()
      row.innerHTML = `
        <div>${rankIcon} ${index + 1}</div>
        <div>${player.username}</div>
        <div>ğŸ° ${player.biggestWin.toFixed(2)}</div>
        <div>${player.gameType || 'N/A'}</div>
        <div>ğŸ“… ${date}</div>
      `
    } else if (currentTab === 'level') {
      const badge = getLevelBadge(player.level)
      const tier = getLevelTier(player.level)
      const totalXP = getTotalXP(player.level, player.xp)
      const vipClass = player.level >= 1000 ? 'vip-crown' : ''
      
      row.innerHTML = `
        <div>${rankIcon} ${index + 1}</div>
        <div>${player.username}</div>
        <div><span class="level-badge ${vipClass}">${badge}</span> ${player.level}</div>
        <div>${tier}</div>
        <div>â­ ${totalXP.toLocaleString()}</div>
      `
    }
    
    list.appendChild(row)
  })
}

function switchTab(tab) {
  currentTab = tab
  
  // Update active tab
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'))
  event.target.classList.add('active')
  
  loadLeaderboard()
}

loadLeaderboard()
setInterval(loadLeaderboard, 10000)
</script>

<%- include('partials/footer') %>
