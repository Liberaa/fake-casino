<%- include('../partials/header') %>
<%- include('../partials/navbar', { user }) %>

<style>

/* ============================= */
/* Dice Layout ‚Äì Professional   */
/* ============================= */

.roulette-container {
  max-width: 1100px;
  margin: 0 auto;
  padding: 2.5rem 2rem;
}

.roulette-header {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.8rem;
  margin-bottom: 2rem;
}

.roulette-header h1 {
  font-size: 2.2rem;
  letter-spacing: 2px;
}

.balance-small {
  background: rgba(251, 191, 36, 0.15);
  color: #fbbf24;
  padding: 0.4rem 1rem;
  border-radius: 999px;
  font-weight: 800;
}

/* ============================= */
/* Multiplier Display            */
/* ============================= */

.multiplier-display {
  background: linear-gradient(135deg, #16171a 0%, #281936 100%);
  padding: 1.5rem;
  border-radius: 15px;
  margin-bottom: 2rem;
  text-align: center;
  box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
  border: 2px solid rgba(255, 255, 255, 0.1);
}

.multiplier-display h3 {
  margin: 0 0 0.5rem 0;
  font-size: 0.9rem;
  opacity: 0.9;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: #e2d7d7d8;
}

.multiplier-value {
  font-size: 3rem;
  font-weight: 900;
  color: #3a3323b6;
  text-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
}

.payout-info {
  margin-top: 0.5rem;
  font-size: 1.1rem;
  opacity: 0.9;
  color: #fff;
}

.payout-info span {
  color: #fbbf24;
  font-weight: 800;
}

.win-chance {
  margin-top: 0.5rem;
  font-size: 0.9rem;
  opacity: 0.8;
  color: #fff;
}

.win-chance span {
  color: #22c55e;
  font-weight: 800;
}

/* ============================= */
/* Reel Section                  */
/* ============================= */

.wheel-section {
  background: rgba(0, 0, 0, 0.35);
  border-radius: 18px;
  padding: 2.5rem 2rem 2rem;
  margin-bottom: 2.5rem;
  text-align: center;
}

.reel-display {
  display: flex;
  justify-content: center;
  align-items: center;
  position: relative;
  height: 140px;
  margin: 1.5rem 0 0.5rem;
}

.reel-wrapper {
  width: 700px;
  overflow: hidden;
  position: relative;
  mask-image: linear-gradient(to right, transparent, black 20%, black 80%, transparent);
  -webkit-mask-image: linear-gradient(to right, transparent, black 20%, black 80%, transparent);
}

.center-indicator {
  position: absolute;
  width: 100px;
  height: 100px;
  border: 3px solid #fbbf24;
  border-radius: 50%;
  pointer-events: none;
  z-index: 5;
  box-shadow: 0 0 30px rgba(251,191,36,0.6);
}

/* ============================= */
/* Dice Reel                     */
/* ============================= */

#diceReel {
  display: flex;
  gap: 1rem;
  will-change: transform;
}

#diceReel.looping {
  animation: dice-scroll-loop 10s linear infinite;
}

#diceReel.stopping {
  animation: dice-scroll-to-win 3s cubic-bezier(0.25, 0.1, 0.25, 1) forwards;
}

#diceReel .reel-slot {
  width: 80px;
  height: 80px;
  border-radius: 16px;
  background: rgba(17, 24, 39, 0.95);
  color: #fbbf24;
  font-size: 2.4rem;
  font-weight: 900;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  box-shadow:
    inset 0 0 18px rgba(0,0,0,0.8),
    0 6px 12px rgba(0,0,0,0.45);
}

#diceReel .reel-slot.win {
  background: linear-gradient(145deg, #22c55e, #16a34a);
  color: #000;
  box-shadow: 0 0 30px rgba(34,197,94,0.9);
  animation: dice-win-pulse 0.8s ease-out;
}

/* ============================= */
/* Result Text                   */
/* ============================= */

#finalResult {
  margin-top: 1.8rem;
  font-size: 2.3rem;
  font-weight: 900;
  text-align: center;
}

/* ============================= */
/* Bet Controls                  */
/* ============================= */

.bet-input-section {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1.6rem;
  margin-bottom: 2.5rem;
}

.dice-toggle-row {
  display: flex;
  justify-content: center;
  gap: 1rem;
}

.dice-toggle {
  background: rgba(0,0,0,0.45);
  border: 2px solid rgba(255,255,255,0.15);
  color: #9ca3af;
  padding: 0.7rem 2.2rem;
  border-radius: 999px;
  font-weight: 800;
  letter-spacing: 1px;
  cursor: pointer;
  transition: all 0.25s ease;
}

.dice-toggle.active {
  background: linear-gradient(135deg, #2b2d35 0%, #764ba2 100%);
  color: #fff;
  border-color: transparent;
  box-shadow: 0 0 22px rgba(52, 53, 56, 0.7);
}

.dice-input-row {
  display: flex;
  justify-content: center;
  gap: 1.6rem;
}

.dice-input-group {
  display: flex;
  align-items: center;
  gap: 0.6rem;
  background: rgba(0,0,0,0.45);
  border: 1px solid rgba(66, 61, 61, 0.15);
  border-radius: 12px;
  padding: 0.7rem 1rem;
}

.dice-input {
  background: transparent;
  border: none;
  outline: none;
  color: #fbbf24;
  font-size: 1.15rem;
  font-weight: 800;
  width: 90px;
  text-align: center;
}

.dice-label {
  font-size: 0.8rem;
  opacity: 0.65;
}

/* ============================= */
/* Roll Button                   */
/* ============================= */

.btn-primary {
  padding: 1.1rem 4rem;
  font-size: 1.25rem;
  font-weight: 900;
  border-radius: 14px;
  letter-spacing: 2px;
}

/* ============================= */
/* Animations                    */
/* ============================= */

@keyframes dice-scroll-loop {
  from { transform: translateX(0); }
  to { transform: translateX(-11520px); }
}

@keyframes dice-scroll-to-win {
  from { transform: translateX(0); }
  to { transform: translateX(-9290px); }
}

@keyframes dice-win-pulse {
  0% {
    transform: scale(1);
    box-shadow: 0 0 0 rgba(34,197,94,0.6);
  }
  50% {
    transform: scale(1.15);
    box-shadow: 0 0 40px rgba(34,197,94,1);
  }
  100% {
    transform: scale(1);
    box-shadow: 0 0 25px rgba(34,197,94,0.9);
  }
}

</style>


<div class="roulette-container">

  <!-- Header -->
  <div class="roulette-header">
    <h1>üé≤ DICE</h1>
    <div class="balance-small">
      üí∞ <span id="credits"><%= user.credits.toFixed(2) %></span>
    </div>
  </div>

  <!-- Multiplier Display -->
  <div class="multiplier-display">
    <h3>Potential Win</h3>
    <div class="multiplier-value" id="multiplierDisplay">2.00x</div>
    <div class="payout-info">
      Bet <span id="displayBet">10.00</span> ‚Üí Win <span id="displayWin">20.00</span>
    </div>
    <div class="win-chance">
      Win Chance: <span id="displayChance">50.00</span>%
    </div>
  </div>

  <!-- Dice Reel -->
  <div class="wheel-section">

    <div class="rolling-display" id="rollingText" style="display:none;">
      ROLLING‚Ä¶
    </div>

    <div class="reel-display">
      <div class="reel-wrapper">
        <div class="reel-container" id="diceReel"></div>
      </div>
      <div class="center-indicator"></div>
    </div>

    <!-- Final Result (CLEAR + BIG) -->
    <div
      id="finalResult"
      style="
        text-align:center;
        font-size:2.2rem;
        font-weight:900;
        margin-top:1.5rem;
        display:none;
      "
    ></div>

  </div>

  <!-- Bet Controls -->
  <div class="bet-input-section">

    <!-- Over / Under Toggle -->
    <div class="bet-input-row dice-toggle-row">
      <button
        id="underBtn"
        class="dice-toggle active"
        onclick="setDiceMode('under')"
      >
        UNDER
      </button>

      <button
        id="overBtn"
        class="dice-toggle"
        onclick="setDiceMode('over')"
      >
        OVER
      </button>
    </div>

    <!-- Inputs -->
    <div class="bet-input-row dice-input-row">

      <div class="dice-input-group">
        <span class="dice-input-icon">üíµ</span>
        <input
          type="number"
          id="betAmount"
          class="dice-input"
          value="10"
          min="1"
          max="<%= user.credits %>"
          step="0.01"
          oninput="updateMultiplier()"
        />
      </div>

      <div class="dice-input-group">
        <span class="dice-input-icon">üéØ</span>
        <input
          type="number"
          id="target"
          class="dice-input"
          value="50"
          min="2"
          max="98"
          oninput="updateMultiplier()"
        />
        <span class="dice-label" id="rollLabel">Roll Under</span>
      </div>

    </div>
  </div>

  <!-- Roll Button -->
  <div style="text-align:center; margin-bottom:2rem;">
    <button
      onclick="rollDice()"
      class="btn-primary"
      style="padding:1rem 3rem; font-size:1.2rem;"
    >
      ROLL
    </button>
  </div>

  <!-- Back -->
  <div style="text-align:center;">
    <a href="/lobby" class="btn-back">‚Üê Back to Lobby</a>
  </div>

</div>

<script>
const socket = io()
const username = '<%= user.username %>'

/* ============================= */
/* State                         */
/* ============================= */

let diceMode = 'under'
let isRolling = false
let currentCredits = Number('<%= user.credits %>')

document.getElementById('credits').textContent =
  currentCredits.toFixed(2)

/* ============================= */
/* Calculate Multiplier          */
/* ============================= */

function calculateMultiplier() {
  const target = Number(document.getElementById('target').value)
  let multiplier
  let winChance
  
  if (diceMode === 'under') {
    multiplier = 99 / target
    winChance = (target - 1) // chance = target - 1 (e.g., under 50 = 49% chance)
  } else {
    multiplier = 99 / (100 - target)
    winChance = (100 - target - 1) // chance = 100 - target - 1
  }
  
  // Cap at 99x
  multiplier = Math.min(multiplier, 99)
  
  return {
    multiplier: multiplier,
    winChance: winChance
  }
}

/* ============================= */
/* Update Multiplier Display     */
/* ============================= */

function updateMultiplier() {
  const betAmount = Number(document.getElementById('betAmount').value) || 0
  const { multiplier, winChance } = calculateMultiplier()
  
  const potentialWin = betAmount * multiplier
  
  document.getElementById('multiplierDisplay').textContent = multiplier.toFixed(2) + 'x'
  document.getElementById('displayBet').textContent = betAmount.toFixed(2)
  document.getElementById('displayWin').textContent = potentialWin.toFixed(2)
  document.getElementById('displayChance').textContent = winChance.toFixed(2)
  
  // Change color based on multiplier
  const display = document.getElementById('multiplierDisplay')
  if (multiplier >= 10) {
    display.style.color = '#ef4444' // Red for high risk
  } else if (multiplier >= 5) {
    display.style.color = '#f59e0b' // Orange for medium
  } else {
    display.style.color = '#fbbf24' // Gold for low
  }
}

/* ============================= */
/* Over / Under Toggle           */
/* ============================= */

function setDiceMode(mode) {
  diceMode = mode

  const underBtn = document.getElementById('underBtn')
  const overBtn = document.getElementById('overBtn')
  const label = document.getElementById('rollLabel')

  if (mode === 'under') {
    underBtn.classList.add('active')
    overBtn.classList.remove('active')
    label.textContent = 'Roll Under'
  } else {
    overBtn.classList.add('active')
    underBtn.classList.remove('active')
    label.textContent = 'Roll Over'
  }
  
  updateMultiplier()
}

/* ============================= */
/* Reel Generation (Idle Loop)   */
/* ============================= */

function generateDiceReelLoop() {
  const reel = document.getElementById('diceReel')
  const items = []

  for (let i = 0; i < 120; i++) {
    const n = (i % 100) + 1
    items.push(`<div class="reel-slot">${n}</div>`)
  }

  reel.innerHTML = items.join('')
  reel.classList.remove('stopping')
  reel.classList.add('looping')
}

/* ============================= */
/* Reel Stop Animation           */
/* ============================= */

function animateDiceReelStop(finalNumber) {
  const reel = document.getElementById('diceReel')
  reel.classList.remove('looping')

  const items = []

  // Random filler before
  for (let i = 0; i < 100; i++) {
    const n = Math.floor(Math.random() * 100) + 1
    items.push(`<div class="reel-slot">${n}</div>`)
  }

  // Winning number
  items.push(`<div class="reel-slot win">${finalNumber}</div>`)

  // Buffer after
  for (let i = 0; i < 20; i++) {
    const n = Math.floor(Math.random() * 100) + 1
    items.push(`<div class="reel-slot">${n}</div>`)
  }

  reel.innerHTML = items.join('')

  requestAnimationFrame(() => {
    reel.classList.add('stopping')
  })
}

/* ============================= */
/* Main Dice Roll                */
/* ============================= */

async function rollDice() {
  if (isRolling) return
  
  const betAmount = Number(document.getElementById('betAmount').value)
  const target = Number(document.getElementById('target').value)

  // Validation
  if (betAmount <= 0) {
    alert('Bet amount must be greater than 0')
    return
  }
  
  if (betAmount > currentCredits) {
    alert(`Insufficient credits! You only have ${currentCredits.toFixed(2)} coins`)
    return
  }
  
  if (target < 2 || target > 98) {
    alert('Target must be between 2 and 98')
    return
  }

     if (typeof emitBetPlaced === 'function') {
    emitBetPlaced(betAmount)
  }
  
  isRolling = true

  const rollingText = document.getElementById('rollingText')
  const finalResult = document.getElementById('finalResult')
  const rollButton = document.querySelector('.btn-primary')

  // Disable button
  rollButton.disabled = true
  rollButton.style.opacity = '0.6'
  rollButton.style.cursor = 'not-allowed'

  // Reset UI
  finalResult.style.display = 'none'
  finalResult.textContent = ''
  rollingText.style.display = 'block'

  // Deduct bet immediately (UI lock)
  currentCredits -= betAmount
  document.getElementById('credits').textContent =
    currentCredits.toFixed(2)

  generateDiceReelLoop()

  try {
    const res = await fetch('/games/dice', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        betAmount,
        target,
        mode: diceMode
      })
    })

    const data = await res.json()
    
    // Check for error from server
    if (!data.success) {
      alert(data.error || 'Bet failed')
      // Refund
      currentCredits += betAmount
      document.getElementById('credits').textContent = currentCredits.toFixed(2)
      
      rollingText.style.display = 'none'
      isRolling = false
      rollButton.disabled = false
      rollButton.style.opacity = '1'
      rollButton.style.cursor = 'pointer'
      return
    }

    // Start stopping animation
    setTimeout(() => {
      animateDiceReelStop(data.roll)
    }, 800)

    // Finalize result
    setTimeout(() => {
      rollingText.style.display = 'none'
      finalResult.style.display = 'block'

      if (data.win) {
        finalResult.style.color = '#22c55e'
        finalResult.textContent =
          `üéâ Rolled ${data.roll} ‚Äî You WON ${data.winAmount.toFixed(2)} coins (${data.multiplier.toFixed(2)}x)`

        // Add winnings
        currentCredits += data.winAmount
      } else {
        finalResult.style.color = '#ef4444'
        finalResult.textContent =
          `üò¢ Rolled ${data.roll} ‚Äî You lost ${betAmount.toFixed(2)} coins`
      }

      document.getElementById('credits').textContent =
        currentCredits.toFixed(2)
      
      // Update max bet allowed
      document.getElementById('betAmount').max = currentCredits

      socket.emit('game:result', {
        username,
        gameType: 'dice',
        result: data.win ? 'win' : 'loss',
        amount: data.win ? data.winAmount : betAmount
      })

      // Unlock roll
      isRolling = false
      rollButton.disabled = false
      rollButton.style.opacity = '1'
      rollButton.style.cursor = 'pointer'

    }, 3200)

  } catch (err) {
    console.error('Dice roll failed:', err)

    // Refund on failure
    currentCredits += betAmount
    document.getElementById('credits').textContent =
      currentCredits.toFixed(2)

    rollingText.style.display = 'none'

    // Unlock
    isRolling = false
    rollButton.disabled = false
    rollButton.style.opacity = '1'
    rollButton.style.cursor = 'pointer'
  }
}

/* ============================= */
/* Init                           */
/* ============================= */

generateDiceReelLoop()
updateMultiplier()

/* ============================= */
/* Spacebar to Roll              */
/* ============================= */

document.addEventListener('keydown', (e) => {
  // Only trigger on spacebar
  if (e.code === 'Space' || e.keyCode === 32) {
    // Prevent page scroll
    e.preventDefault()
    
    // Don't roll if already rolling
    if (!isRolling) {
      rollDice()
    }
  }
})
</script>


<%- include('../partials/footer') %>
